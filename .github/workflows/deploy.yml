# This workflow builds and deploys the demo-ui to AWS App Runner
# It uses runtime configuration - different configs for prod/dev baked into the image at build time
# Customer instances can use the same image with volume-mounted custom configs

name: Deploy Demo to AWS

on:
  push:
    branches:
      - main  # Production
      - dev   # Development

# Permissions needed for OIDC to work
permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    environment:
      name: ${{ (github.ref == 'refs/heads/main' && 'Production') || 'Development' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: eu-central-1

      - name: Prepare environment-specific config
        run: |
          # Environment is automatically selected based on branch
          # Variables are scoped to the environment (no need for PROD_/DEV_ prefix)
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="development"
          fi
          
          FLOOR_WIDTH="${{ vars.FLOOR_WIDTH || '50' }}"
          FLOOR_LENGTH="${{ vars.FLOOR_LENGTH || '30' }}"
          LOAD_DATA="${{ vars.LOAD_INITIAL_DATA || 'true' }}"
          FENCES='${{ vars.FENCES }}'
          ZONE_POSITION='${{ vars.ZONE_POSITION }}'
          GCP='${{ vars.GROUND_CONTROL_POINTS }}'
          
          echo "üîß Building for $ENV environment"
          
          # Use defaults if variables not set
          if [ -z "$FENCES" ] || [ "$FENCES" = "null" ]; then
            FENCES='[{"id":"fence-1","name":"Test Fence 1","region":{"type":"Polygon","coordinates":[[[15,5],[35,5],[35,15],[15,15],[15,5]]]},"floor":0,"crs":"local"}]'
          fi
          
          if [ -z "$ZONE_POSITION" ] || [ "$ZONE_POSITION" = "null" ]; then
            ZONE_POSITION='[7.815694, 48.130216]'
          fi
          
          if [ -z "$GCP" ] || [ "$GCP" = "null" ]; then
            GCP='[{"wgs84":[7.815694,48.130216],"local":[0,0]},{"wgs84":[7.816551,48.130216],"local":[50,0]},{"wgs84":[7.815694,48.13031],"local":[0,30]},{"wgs84":[7.816551,48.13031],"local":[50,30]}]'
          fi
          
          # Create environment-specific config from GitHub variables
          cat > config/default-config.json <<EOF
          {
            "floor": {
              "width": ${FLOOR_WIDTH},
              "length": ${FLOOR_LENGTH}
            },
            "zone": {
              "id": null,
              "position": ${ZONE_POSITION},
              "groundControlPoints": ${GCP}
            },
            "fences": ${FENCES},
            "initialData": {
              "loadInitialData": ${LOAD_DATA},
              "providers": [
                {"id":"provider-uwb-001","type":"uwb","name":"UWB Tag 1"},
                {"id":"provider-ble-001","type":"ble-aoa","name":"BLE Tag 1"}
              ],
              "trackables": [
                {"id":"trackable-asset-001","type":"omlox","name":"Asset #001","location_providers":["provider-uwb-001","provider-ble-001"]}
              ],
              "locations": {
                "provider-uwb-001": {"position":{"type":"Point","coordinates":[10,20]},"source":"demo-zone","provider_type":"uwb","provider_id":"provider-uwb-001","crs":"local","floor":0,"accuracy":0.5,"trackables":["trackable-asset-001"]},
                "provider-ble-001": {"position":{"type":"Point","coordinates":[30,20]},"source":"demo-zone","provider_type":"ble-mesh","provider_id":"provider-ble-001","crs":"local","floor":0,"accuracy":1.5,"trackables":["trackable-asset-001"]},
                "trackable-asset-001": {"position":{"type":"Point","coordinates":[5,5]},"source":"demo-zone","provider_type":"uwb","provider_id":"provider-uwb-001","crs":"local","floor":0,"accuracy":0.5}
              }
            }
          }
          EOF
          
          # Validate JSON
          echo "üìã Validating config JSON..."
          cat config/default-config.json | jq . > /dev/null || exit 1
          echo "‚úÖ Config validated for $ENV"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Determine semantic tag based on branch
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            SEMANTIC_TAG="latest"
            ENV_TAG="prod"
          else
            SEMANTIC_TAG="dev"
            ENV_TAG="dev"
          fi
          
          echo "üè∑Ô∏è  Building image with tags: $IMAGE_TAG, $SEMANTIC_TAG, $ENV_TAG"
          
          # Build with environment-specific config baked in
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          
          # Tag for easy reference
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$SEMANTIC_TAG
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$ENV_TAG
          
          # Push all tags
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$SEMANTIC_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$ENV_TAG
          
          echo "IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV
          echo "‚úÖ Images pushed to ECR"

      - name: Restore default config (cleanup)
        if: always()
        run: |
          git checkout config/default-config.json

      - name: Deploy to AWS App Runner
        run: |
          echo "üöÄ Deploying to App Runner..."
          aws apprunner update-service \
            --service-arn ${{ vars.APP_RUNNER_SERVICE_ARN }} \
            --source-configuration "ImageRepository={ImageIdentifier=${{ env.IMAGE_URI }},ImageRepositoryType=ECR,ImageConfiguration={Port=80}}" \
            --region eu-central-1

      - name: Wait for deployment to complete
        run: |
          echo "‚è≥ Waiting for App Runner service to update..."
          aws apprunner wait service-updated \
            --service-arn ${{ vars.APP_RUNNER_SERVICE_ARN }} \
            --region eu-central-1 || true
          echo "‚úÖ Deployment completed!"
